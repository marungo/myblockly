<html>
<head>
	<title>Blockly Turtleblocks</title>
	<!-- <link rel="stylesheet" type="text/css" href="styles.css" /> -->
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="styles.css" />
	<script src="blockly/blockly_uncompressed.js"></script>
	<script src="blockly/blockly_compressed.js"></script>
    <script src="blockly/generators/javascript.js"></script>
    <script src="blockly/msg/js/en.js"></script>
    <script src="js-interpreter/acorn_interpreter.js"></script>
    <!--Scripts for my blocks-->
    <script src="myblocks.js"></script>
    <!--Scripts for Neil's blocks-->
    <script src="blockly/blocks/logic.js"></script>
    <script src="blockly/blocks/loops.js"></script>
    <script src="blockly/blocks/math.js"></script>
    <script src="blockly/blocks/variables.js"></script>
    <script src="blockly/blocks/procedures.js"></script>
    <!--Script for Turtle movements-->
    <script src="turtle.js"></script>
</head>
<body>
	<h1 id="header">Blockly Makes Blocks</h1>
	
	<!-- TABLE WHERE CANVAS AND BLOCKLY INJECTION COMMUNICATE-->
	<table width="100%" height="500px">
		<tr>
			<td id="broadcast" width="500px">
				<div id="blockly" style="height:90%"></div>
				<button onclick="initializeTurtle()">Start</button>
				<button onclick="run_code()">Run</button>
				<button onclick="resetEverything()">Reset</button>
			</td>
			<td id="receive">
				<canvas id="myCanvas" style="border:1px solid #000000;" width="600px" height="500px">
				<img id="turtle" src="turtle.jpg">
			</td>
		</tr>
	</table>

	<!-- TOOLBOX -->
	<xml id="toolbox" style="display: none">
      <category name="Colors">
        <block type='color_yellow'></block>
      </category>
      <category name="Movement">
        <block type="move"></block>
        <block type="turnLeft"></block>
        <block type="turnRight"></block>
        <block type="moveTo"></block>
     </category>
     <category name="Pen">
        <block type="pen"></block>
        <block type="width"></block>
        <block type="penColor"></block>
      </category>
      <category name="Variables" custom="VARIABLE"></category>
	  <category name="Functions" custom="PROCEDURE"></category>
      <category name="Math">
        <block type="number"></block>
        <block type="math_arithmetic"></block>
        <block type="math_single"></block>
        <block type="math_trig"></block>
        <block type="math_change"></block>
        <block type="math_round"></block>
        <block type="math_modulo"></block>
		<block type="math_random_int"></block>
		<block type="math_random_float"></block>
      </category>
      <category name="Control">
        <block type="controls_if"></block>
        <block type="controls_if_else"></block>
        <block type="controls_repeat"></block>
        <block type="controls_repeat_ext"></block>
        <block type="controls_forEach"></block>
        <block type="controls_for"></block>
        <block type="controls_whileUntil"></block>
        <block type="procedures_ifreturn"></block>
      </category>
      <category name="Logic">
        <block type="logic_compare"></block>
        <block type="logic_operation"></block>
        <block type="logic_boolean"></block>
      </category>
      <category name="Variables">
        <block type="variables_set"></block>
        <block type="variables_get"></block>
      </category>  
    </xml>

	<script>
		var x = 0;
		var y = 0;
		var angle = 0;
		var visible = true;
		var initialized = false;
		var c;
		var ctx;
		var turtle = document.getElementById('turtle');
		// We might have to 
		var allCode = "resetCanvas();\n";//start from beginning
		var drawMyTurtle = "ctx.drawImage(turtle,-(TURTLE_WIDTH/2), -(TURTLE_HEIGHT/2), TURTLE_WIDTH, TURTLE_HEIGHT);"//add turtle
		var TURTLE_HEIGHT = 18;
		var TURTLE_WIDTH = 22;
		// var QUARTER_TURN_RADIANS = 90 * (Math.PI/180);

		function initializeTurtle() {
			if (!initialized) {
				c = document.getElementById("myCanvas");
				ctx = c.getContext('2d');
				initialized = true;
			}
			resetEverything();
			//draw image of turtle to show where user is
			drawTurtle();
		}

		function resetCanvas() {
			ctx.restore();//default positions
			ctx.save();
			ctx.clearRect(0, 0, c.width, c.height);
			// return to original Turtle settings
			ctx.translate(c.width/2.0,c.height/2.0);
			// x = 0;
			// y = 0;
			ctx.moveTo(0,0);
			//reset angles, draw circle to indicate where it is
			angle = 0;
		}

		function resetEverything() {
			resetCanvas();
			allCode = "resetCanvas();"
		}

		var blocklyArea = document.getElementById("blockly");
		var workspace = Blockly.inject(blocklyArea,
	      {toolbox: document.getElementById('toolbox')});

		window.blockly_loaded = function(blockly) {
			return window.Blockly = blockly;
		}
		
		window.run_code = function() {
			Blockly.JavaScript.addReservedWords('code');
			code = window.Blockly.JavaScript.workspaceToCode();
			// var myInterpreter = new Interpreter(code, initApi);
			// myInterpreter.run();
			console.log(code);
			try {
				eval(code);
			} catch (e) {
				alert(e);
			}
		}

		// function initApi(interpreter, scope) {
		//   // Add an API function for the alert() block.
		//   var wrapper = function(text) {
		//     text = text ? text.toString() : '';
		//     return interpreter.createPrimitive(alert(text));
		//   };
		//   interpreter.setProperty(scope, 'alert',
		//       interpreter.createNativeFunction(wrapper));

		//   // Add an API function for the prompt() block.
		//   wrapper = function(text) {
		//     text = text ? text.toString() : '';
		//     return interpreter.createPrimitive(prompt(text));
		//   };
		//   interpreter.setProperty(scope, 'prompt',
		//       interpreter.createNativeFunction(wrapper));
		// }

		// function nextStep() {
		// 	if (myInterpreter.step()) {
		// 		window.setTimeout(nextStep, 10);
		// 	}
		// }
		// nextStep();
	</script>
    <!--Scripts for my generator-->
	<script src="myjavascript.js"></script>
    <!--Scripts for Neil's generators-->
    <script src="blockly/generators/javascript/logic.js"></script>
    <script src="blockly/generators/javascript/loops.js"></script>
    <script src="blockly/generators/javascript/math.js"></script>
    <script src="blockly/generators/javascript/variables.js"></script>
    <script src="blockly/generators/javascript/procedures.js"></script>
</body>
</html>
